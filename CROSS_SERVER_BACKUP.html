<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cross-Server Backup & Restore Guide - RackPlane Documentation</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1 class="logo">RackPlane</h1>
                <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle sidebar">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="Search documentation...">
                <div id="searchResults" class="search-results"></div>
            </div>
            <nav class="nav-menu" id="navMenu">
                <div class="nav-category">Getting Started</div>
<ul class="nav-items">
<li><a href="README.html" class="">RackPlane Documentation</a></li>
</ul>
<div class="nav-category">Setup & Installation</div>
<ul class="nav-items">
<li><a href="DEPLOYMENT.html" class="">Deployment Guide</a></li>
<li><a href="NETBOX_SETUP.html" class="">NetBox Integration Setup Guide</a></li>
<li><a href="LABEL_PRINTING.html" class="">Label Printing Guide</a></li>
<li><a href="QUICK_FIX.html" class="">üö® QUICK FIX: Database "dcms" Does Not Exist</a></li>
</ul>
<div class="nav-category">User Guides</div>
<ul class="nav-items">
<li><a href="STOCK_MANAGEMENT_GUIDE.html" class="">Stock Management Guide</a></li>
<li><a href="TENANT_ONBOARDING.html" class="">Tenant Onboarding Documentation</a></li>
</ul>
<div class="nav-category">Backup & Recovery</div>
<ul class="nav-items">
<li><a href="BACKUP_GUIDE.html" class="">Database Backup & Restore Guide</a></li>
<li><a href="CROSS_SERVER_BACKUP.html" class="active">Cross-Server Backup & Restore Guide</a></li>
<li><a href="EMERGENCY_RECOVERY.html" class="">üö® EMERGENCY DATABASE RECOVERY GUIDE</a></li>
</ul>
<div class="nav-category">API Reference</div>
<ul class="nav-items">
<li><a href="API_DOCUMENTATION.html" class="">API Documentation</a></li>
</ul>
            </nav>
        </aside>
        <main class="content">
            <article class="doc-content">
                <h1>Cross-Server Backup & Restore Guide</h1>

<h2>Overview</h2>

<p>This guide explains how to backup your DCMS installation from one server and restore it to another server, including all database data, photos, and metadata.</p>

<h2>Backup Types</h2>

<h3>Full Backup (Recommended)</h3>
<p>Includes:</p>
<ul>
<li>Complete database (all tables, all tenants)</li>
<li>All uploaded files (photos, documents)</li>
<li>Backup metadata</li>
</ul>

<p>Format: <code>.tar.gz</code> archive</p>

<h3>Database-Only Backup</h3>
<p>Includes:</p>
<ul>
<li>Complete database (all tables, all tenants)</li>
<li>No files</li>
</ul>

<p>Format: <code>.json</code> file</p>

<h2>Backup Process</h2>

<h3>On Source Server</h3>

<h4>Option 1: Using Docker (Recommended)</h4>

<pre><code class="language-bash"># Navigate to project directory
cd /path/to/dcms

# Create full backup with auto-generated timestamp filename
docker compose exec backend python backup_cli.py export
# Creates: dcms_backup_2025-11-27_14-30-45.tar.gz in /app/

# Or specify output directory (auto-generates filename with timestamp)
docker compose exec backend python backup_cli.py export --output /tmp/
# Creates: /tmp/dcms_backup_2025-11-27_14-30-45.tar.gz

# Or create database-only backup
docker compose exec backend python backup_cli.py export --database-only
# Creates: dcms_backup_2025-11-27_14-30-45.json

# Copy backup file from container to host
docker cp rackplane_backend:/app/rackplane_backup_*.tar.gz ./backups/

# Or if using host volume mount, backup is already on host
</code></pre>

<h4>Option 2: Direct Execution (if running outside Docker)</h4>

<pre><code class="language-bash">cd /path/to/dcms/backend

# Full backup
python backup_cli.py export --output ../backups/dcms_backup.tar.gz

# Database-only backup
python backup_cli.py export --output ../backups/dcms_backup.json --database-only
</code></pre>

<h3>View Backup Summary</h3>

<pre><code class="language-bash"># View information about a backup archive
docker compose exec backend python backup_cli.py summary /tmp/dcms_backup.tar.gz
</code></pre>

<h2>Transfer Backup to Target Server</h2>

<h3>Method 1: SCP (Secure Copy)</h3>

<pre><code class="language-bash"># From source server
scp /path/to/backups/dcms_backup.tar.gz user@target-server:/path/to/backups/

# Or from target server
scp user@source-server:/path/to/backups/dcms_backup.tar.gz /path/to/backups/
</code></pre>

<h3>Method 2: rsync (Recommended for large files)</h3>

<pre><code class="language-bash"># From source server
rsync -avz --progress /path/to/backups/dcms_backup.tar.gz user@target-server:/path/to/backups/
</code></pre>

<h3>Method 3: Cloud Storage</h3>

<pre><code class="language-bash"># Upload to S3
aws s3 cp dcms_backup.tar.gz s3://my-bucket/dcms-backups/

# Download on target server
aws s3 cp s3://my-bucket/dcms-backups/dcms_backup.tar.gz ./
</code></pre>

<h3>Method 4: USB Drive / External Storage</h3>

<ol>
<li>Copy backup file to USB drive on source server</li>
<li>Transfer USB drive to target server</li>
<li>Copy backup file from USB drive</li>
</ol>

<h2>Restore Process</h2>

<h3>On Target Server</h3>

<h4>Prerequisites</h4>

<ol>
<li><strong>DCMS must be installed</strong> on the target server</li>
<li><strong>Docker containers must be running</strong> (if using Docker)</li>
<li><strong>Database must be initialized</strong> (run <code>bootstrap.py</code> if needed)</li>
</ol>

<h4>Option 1: Using Docker (Recommended)</h4>

<pre><code class="language-bash"># Navigate to project directory
cd /path/to/dcms

# Copy backup file to container (if not already there)
docker cp /path/to/backups/rackplane_backup.tar.gz rackplane_backend:/tmp/

# Restore full backup
docker compose exec backend python restore_cli.py restore /tmp/dcms_backup.tar.gz

# Restore and clear existing data (‚ö†Ô∏è DANGEROUS - deletes all current data)
docker compose exec backend python restore_cli.py restore /tmp/dcms_backup.tar.gz --clear

# Restore database only (skip files)
docker compose exec backend python restore_cli.py restore /tmp/dcms_backup.tar.gz --skip-files

# Restore from JSON backup (database only)
docker compose exec backend python restore_cli.py restore /tmp/dcms_backup.json --clear
</code></pre>

<h4>Option 2: Direct Execution</h4>

<pre><code class="language-bash">cd /path/to/dcms/backend

# Restore full backup
python restore_cli.py restore ../backups/dcms_backup.tar.gz

# Restore with clear existing
python restore_cli.py restore ../backups/dcms_backup.tar.gz --clear
</code></pre>

<h2>Complete Cross-Server Migration Example</h2>

<h3>Step 1: Backup on Source Server</h3>

<pre><code class="language-bash"># On source server
cd /home/user/dcms
docker compose exec backend python backup_cli.py export --output /tmp/dcms_migration_backup.tar.gz
docker cp rackplane_backend:/tmp/rackplane_migration_backup.tar.gz ./
</code></pre>

<h3>Step 2: Transfer to Target Server</h3>

<pre><code class="language-bash"># From source server
scp dcms_migration_backup.tar.gz user@target-server:/home/user/backups/
</code></pre>

<h3>Step 3: Setup Target Server</h3>

<pre><code class="language-bash"># On target server
cd /home/user/dcms

# Start services (if not already running)
docker compose up -d

# Wait for services to be ready
sleep 10

# Initialize database (if fresh installation)
docker compose exec backend alembic upgrade head
docker compose exec backend python bootstrap.py
</code></pre>

<h3>Step 4: Restore on Target Server</h3>

<pre><code class="language-bash"># On target server
cd /home/user/dcms

# Copy backup to container
docker cp /home/user/backups/rackplane_migration_backup.tar.gz rackplane_backend:/tmp/

# Restore (clears existing data and restores from backup)
docker compose exec backend python restore_cli.py restore /tmp/dcms_migration_backup.tar.gz --clear
</code></pre>

<h3>Step 5: Verify Restore</h3>

<pre><code class="language-bash"># Check database
docker compose exec backend python -c "
from app.core.database import SessionLocal
from app.models.asset import Asset
from app.models.user import User
from app.models.tenant import Tenant

db = SessionLocal()
print(f'Tenants: {db.query(Tenant).count()}')
print(f'Users: {db.query(User).count()}')
print(f'Assets: {db.query(Asset).count()}')
db.close()
"

# Check files
docker compose exec backend ls -la /app/uploads/
</code></pre>

<h2>Backup Archive Structure</h2>

<p>A full backup archive (<code>.tar.gz</code>) contains:</p>

<pre><code>dcms_backup.tar.gz
‚îú‚îÄ‚îÄ database.json          # Complete database export
‚îú‚îÄ‚îÄ backup_metadata.json   # Backup information and statistics
‚îî‚îÄ‚îÄ uploads/              # All uploaded files
    ‚îú‚îÄ‚îÄ assets/           # Asset photos
    ‚îÇ   ‚îú‚îÄ‚îÄ photo1.jpg
    ‚îÇ   ‚îî‚îÄ‚îÄ photo2.png
    ‚îî‚îÄ‚îÄ ...
</code></pre>

<h2>Important Notes</h2>

<h3>‚ö†Ô∏è Security Considerations</h3>

<ol>
<li><strong>Backup files contain sensitive data</strong> - Encrypt backups if storing offsite</li>
<li><strong>User passwords</strong> - Passwords are hashed, but backup contains all user data</li>
<li><strong>Tenant isolation</strong> - Backup includes ALL tenants (multi-tenant data)</li>
<li><strong>File permissions</strong> - Ensure backup files have proper permissions</li>
</ol>

<h3>üîí Encrypting Backups</h3>

<pre><code class="language-bash"># Encrypt backup before transfer
gpg --symmetric --cipher-algo AES256 dcms_backup.tar.gz

# Decrypt on target server
gpg --decrypt dcms_backup.tar.gz.gpg &gt; dcms_backup.tar.gz
</code></pre>

<h3>üìä Backup Size Considerations</h3>

<ul>
<li><strong>Database</strong>: Typically 1-100 MB depending on data volume</li>
<li><strong>Files</strong>: Varies greatly (photos can be large)</li>
<li><strong>Full backup</strong>: Database + Files combined</li>
</ul>

<p>For large installations:</p>
<ul>
<li>Consider database-only backups for frequent backups</li>
<li>Use full backups for complete migrations</li>
<li>Compress backups: <code>gzip dcms_backup.tar.gz</code> (already compressed)</li>
</ul>

<h3>üîÑ Restore Options</h3>

<ul>
<li><strong><code>--clear</code></strong>: Deletes ALL existing data before restore (use for fresh migration)</li>
<li><strong>Without <code>--clear</code></strong>: Adds backup data to existing data (may cause duplicates)</li>
<li><strong><code>--skip-files</code></strong>: Restores database only, skips file restoration</li>
</ul>

<h3>‚úÖ Best Practices</h3>

<ol>
<li><strong>Test restore process</strong> on a test server before production migration</li>
<li><strong>Verify backup integrity</strong> using <code>backup_cli.py summary</code> before transfer</li>
<li><strong>Keep multiple backups</strong> - Don't rely on a single backup</li>
<li><strong>Document your process</strong> - Keep notes of what was backed up and when</li>
<li><strong>Verify after restore</strong> - Check that all data is present and correct</li>
</ol>

<h2>Troubleshooting</h2>

<h3>Backup Fails</h3>

<pre><code class="language-bash"># Check database connection
docker compose exec backend python -c "from app.core.database import engine; engine.connect()"

# Check disk space
df -h

# Check logs
docker compose logs backend
</code></pre>

<h3>Restore Fails</h3>

<pre><code class="language-bash"># Check backup file integrity
docker compose exec backend python backup_cli.py summary /tmp/backup.tar.gz

# Check database connection
docker compose exec backend python -c "from app.core.database import engine; engine.connect()"

# Check file permissions
docker compose exec backend ls -la /app/uploads/
</code></pre>

<h3>Files Not Restored</h3>

<pre><code class="language-bash"># Check if uploads directory exists
docker compose exec backend ls -la /app/uploads/

# Manually restore files if needed
docker compose exec backend tar -xzf /tmp/backup.tar.gz -C /tmp/
docker compose exec backend cp -r /tmp/uploads/* /app/uploads/
</code></pre>

<h3>Foreign Key Errors During Restore</h3>

<ul>
<li>Ensure backup was created with the same DCMS version</li>
<li>Check that all required tables are in the backup</li>
<li>Verify backup file is not corrupted</li>
</ul>

<h2>Automated Backup Script</h2>

<p>Create <code>/usr/local/bin/dcms-backup.sh</code>:</p>

<pre><code class="language-bash">#!/bin/bash
# DCMS Automated Backup Script

BACKUP_DIR="/backups/dcms"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="dcms_backup_${DATE}.tar.gz"

# Create backup
cd /path/to/dcms
docker compose exec -T backend python backup_cli.py export --output /tmp/${BACKUP_FILE}

# Copy to host
docker cp rackplane_backend:/tmp/${BACKUP_FILE} ${BACKUP_DIR}/

# Keep only last 7 days of backups
find ${BACKUP_DIR} -name "dcms_backup_*.tar.gz" -mtime +7 -delete

# Optional: Upload to cloud storage
# aws s3 cp ${BACKUP_DIR}/${BACKUP_FILE} s3://my-bucket/dcms-backups/
</code></pre>

<p>Add to crontab:</p>
<pre><code class="language-bash"># Daily backup at 2 AM
0 2 * * * /usr/local/bin/dcms-backup.sh
</code></pre>

<h2>Support</h2>

<p>For issues with backup/restore:</p>
<ol>
<li>Check application logs: <code>docker compose logs backend</code></li>
<li>Verify backup file: <code>python backup_cli.py summary backup.tar.gz</code></li>
<li>Test on a development server first</li>
<li>Review this documentation</li>
</ol>

<hr>

<p><strong>Remember</strong>: Always test your restore process before relying on it for production migrations!</p>


            </article>
        </main>
    </div>
    <script src="app.js"></script>
</body>
</html>